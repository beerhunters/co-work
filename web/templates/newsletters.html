{% extends "base.html" %}
{% block title %}Список рассылок{% endblock %}
{% block content_title %}Все рассылки{% endblock %}
{% block content %}
<style>
    .table-container {
        max-height: 600px;
        overflow-y: auto;
        margin-top: 1rem;
    }
</style>

<div class="card">
    <div class="card-header">
        <div class="d-flex justify-content-between align-items-center">
            <h3 class="card-title">Список рассылок</h3>
            <button id="clearHistoryBtn" class="btn btn-danger">Очистить историю</button>
        </div>
    </div>
    <div class="card-body">
        <div class="table-container">
            <table class="table table-striped table-bordered table-hover">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Сообщение</th>
                        <th>Получателей</th>
                        <th>Дата</th>
                    </tr>
                </thead>
                <tbody id="newslettersTableBody">
                    {% for newsletter in newsletters %}
                    <tr>
                        <td>{{ newsletter.id }}</td>
                        <td>{{ newsletter.message | safe }}</td>
                        <td>{{ newsletter.recipient_count }}</td>
                        <td>{{ newsletter.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="4">Нет рассылок</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const clearHistoryBtn = document.getElementById('clearHistoryBtn');
    clearHistoryBtn.addEventListener('click', function() {
        if (!confirm('Вы уверены, что хотите удалить всю историю рассылок?')) {
            return;
        }
        fetch('/newsletters/clear', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                // Очистка таблицы
                const tableBody = document.getElementById('newslettersTableBody');
                tableBody.innerHTML = '<tr><td colspan="4">Нет рассылок</td></tr>';
                showAlert('success', data.message);
            } else {
                showAlert('danger', data.message);
            }
        })
        .catch(error => {
            showAlert('danger', 'Ошибка при очистке истории рассылок');
            console.error('Error:', error);
        });
    });

    // Функция для отображения уведомлений (предполагается, что она определена в base.html или другом скрипте)
    function showAlert(type, message) {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
        alertDiv.role = 'alert';
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;
        document.body.prepend(alertDiv);
        setTimeout(() => {
            alertDiv.remove();
        }, 5000);
    }
});
</script>
{% endblock %}