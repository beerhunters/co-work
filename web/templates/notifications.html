{% extends "base.html" %}
{% block title %}Уведомления{% endblock %}
{% block content_title %}Уведомления{% endblock %}
{% block content %}
<style>
    .table-container {
        max-height: 600px;
        overflow-y: auto;
        margin-top: 1rem;
    }
    .table-hover {
        font-size: 14px;
    }
    .badge {
        font-size: 12px;
    }
    .pagination {
        margin-top: 1rem;
        justify-content: center;
    }
</style>

<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h3 class="card-title mb-0">Список уведомлений</h3>
        <div class="card-tools">
            <button type="button" class="btn btn-sm btn-primary me-2" onclick="markAllNotificationsReadPage()">
                <i class="fas fa-check-double me-1"></i>Отметить все как прочитанные
            </button>
            <button type="button" class="btn btn-sm btn-danger" id="clearNotificationsBtn">
                <i class="fas fa-trash me-1"></i>Очистить список уведомлений
            </button>
        </div>
    </div>
    <div class="card-body">
        <div class="table-container">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>ID</th>
                            <th>Сообщение</th>
                            <th>Дата создания</th>
                            <th>Статус</th>
                        </tr>
                    </thead>
                    <tbody id="notifications-table-body">
                        {% for notification in recent_notifications %}
                        <tr class="{{ 'table-info' if not notification.is_read else '' }}"
                            data-notification-id="{{ notification.id }}"
                            data-target-url="{{ notification.target_url }}"
                            onclick="redirectToTarget({{ notification.id }}, '{{ notification.target_url }}')"
                            style="cursor: {{ 'pointer' if notification.target_url != '/notifications' and notification.target_url != '#' else 'default' }};">
                            <td>{{ notification.id }}</td>
                            <td class="notification-message">{{ notification.message|truncate(100) }}</td>
                            <td>{{ notification.created_at }}</td>
                            <td>
                                {% if notification.is_read %}
                                    <span class="badge bg-success">Прочитано</span>
                                {% else %}
                                    <span class="badge bg-warning">Непрочитано</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="4" class="text-center text-muted">Нет уведомлений</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% if pagination %}
        <nav aria-label="Пагинация уведомлений">
            <ul class="pagination">
                <li class="page-item {{ 'disabled' if not pagination.has_prev }}">
                    <a class="page-link" href="{{ url_for('notifications', page=pagination.prev_num) if pagination.has_prev else '#' }}" onclick="loadPage({{ pagination.prev_num }}); return false;">Предыдущая</a>
                </li>
                {% for page_num in pagination.iter_pages(left_edge=2, left_current=2, right_current=3, right_edge=2) %}
                {% if page_num %}
                <li class="page-item {{ 'active' if page_num == pagination.page }}">
                    <a class="page-link" href="{{ url_for('notifications', page=page_num) }}" onclick="loadPage({{ page_num }}); return false;">{{ page_num }}</a>
                </li>
                {% else %}
                <li class="page-item disabled"><span class="page-link">...</span></li>
                {% endif %}
                {% endfor %}
                <li class="page-item {{ 'disabled' if not pagination.has_next }}">
                    <a class="page-link" href="{{ url_for('notifications', page=pagination.next_num) if pagination.has_next else '#' }}" onclick="loadPage({{ pagination.next_num }}); return false;">Следующая</a>
                </li>
            </ul>
        </nav>
        {% endif %}
    </div>
</div>

<script>
/**
 * Показывает уведомление Bootstrap.
 * @param {string} type - Тип уведомления ('success', 'danger').
 * @param {string} message - Сообщение для отображения.
 */
function showAlert(type, message) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.role = 'alert';
    alertDiv.innerHTML = `
        ${window.NotificationUtils.escapeHtml(message)}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    `;
    const main = document.querySelector('main');
    if (main) {
        main.prepend(alertDiv);
        setTimeout(() => {
            alertDiv.classList.remove('show');
            setTimeout(() => {
                if (alertDiv.parentNode) alertDiv.remove();
            }, 300);
        }, 5000);
    } else {
        console.error('Не найден элемент main для alert');
    }
}

/**
 * Форматирует сообщение уведомления с указанием типа (Пользователь/Бронь/Заявка).
 * @param {string} message - Исходное сообщение.
 * @param {string} targetUrl - Целевой URL уведомления.
 * @returns {string} Отформатированное сообщение.
 */
function formatNotificationMessage(message, targetUrl) {
    const maxLength = 50;
    let prefix = '';
    let idMatch = targetUrl.match(/\/(booking|ticket|user)\/(\d+)/);

    if (idMatch) {
        const type = idMatch[1];
        const id = idMatch[2];
        if (type === 'booking') prefix = `Бронь #${id}: `;
        else if (type === 'ticket') prefix = `Заявка #${id}: `;
        else if (type === 'user') prefix = `Пользователь #${id}: `;
        message = message.split('\n')[0]; // Берём первую строку
        return prefix + (message.length > maxLength - prefix.length
            ? message.substring(0, maxLength - prefix.length - 3) + '...'
            : message);
    }

    return message.length > maxLength ? message.substring(0, maxLength - 3) + '...' : message;
}

/**
 * Загружает страницу уведомлений через AJAX.
 * @param {number} page - Номер страницы.
 */
function loadPage(page) {
    fetch(`/get_notifications?page=${page}`, {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => {
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        return response.json();
    })
    .then(data => {
        if (data.status === 'success') {
            updateNotificationsTable(data.recent_notifications);
            updatePagination(data.pagination);
            window.history.pushState({}, '', `/notifications?page=${page}`);
        } else {
            window.NotificationUtils.showAlert('danger', data.message || 'Ошибка при загрузке уведомлений');
        }
    })
    .catch(error => {
        console.error('Ошибка:', error);
        window.NotificationUtils.showAlert('danger', `Ошибка при загрузке уведомлений: ${error.message}`);
    });
}

/**
 * Обновляет пагинацию на основе данных от сервера.
 * @param {object} pagination - Данные пагинации {page, per_page, total_pages, total_items}.
 */
function updatePagination(pagination) {
    const paginationContainer = document.querySelector('.pagination');
    if (!paginationContainer) return;

    let html = `
        <li class="page-item ${pagination.page === 1 ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="loadPage(${pagination.page - 1}); return false;">Предыдущая</a>
        </li>
    `;

    const currentPage = pagination.page;
    const totalPages = pagination.total_pages;
    const leftEdge = 2;
    const leftCurrent = 2;
    const rightCurrent = 3;
    const rightEdge = 2;

    let pages = [];
    for (let i = 1; i <= totalPages; i++) {
        if (
            i <= leftEdge ||
            i > totalPages - rightEdge ||
            (i >= currentPage - leftCurrent && i <= currentPage + rightCurrent)
        ) {
            pages.push(i);
        }
    }

    let lastPage = 0;
    pages.forEach(page => {
        if (page - lastPage > 1) {
            html += '<li class="page-item disabled"><span class="page-link">...</span></li>';
        }
        html += `
            <li class="page-item ${page === currentPage ? 'active' : ''}">
                <a class="page-link" href="#" onclick="loadPage(${page}); return false;">${page}</a>
            </li>
        `;
        lastPage = page;
    });

    html += `
        <li class="page-item ${pagination.page === totalPages ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="loadPage(${pagination.page + 1}); return false;">Следующая</a>
        </li>
    `;

    paginationContainer.innerHTML = html;
}

/**
 * Помечает все уведомления как прочитанные на странице.
 */
function markAllNotificationsReadPage() {
    const button = event.target.closest('button');
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Обработка...';
    button.disabled = true;

    fetch('/notifications/mark_all_read', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => {
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        return response.json();
    })
    .then(data => {
        if (data.status === 'success') {
            const rows = document.querySelectorAll('#notifications-table-body tr[data-notification-id]');
            rows.forEach(row => {
                row.classList.remove('table-info');
                const statusCell = row.children[3];
                statusCell.innerHTML = '<span class="badge bg-success">Прочитано</span>';
            });
            window.NotificationUtils.showAlert('success', data.message);
            window.NotificationUtils.loadNotifications();
        } else {
            window.NotificationUtils.showAlert('danger', data.message || 'Ошибка при обновлении уведомлений');
        }
    })
    .catch(error => {
        console.error('Ошибка:', error);
        window.NotificationUtils.showAlert('danger', `Ошибка при обновлении уведомлений: ${error.message}`);
    })
    .finally(() => {
        button.innerHTML = originalText;
        button.disabled = false;
    });
}

/**
 * Переход на целевую страницу с пометкой уведомления как прочитанного.
 * @param {number} notificationId - ID уведомления.
 * @param {string} targetUrl - URL для перехода.
 */
function redirectToTarget(notificationId, targetUrl) {
    console.log(`Переход на ${targetUrl} для уведомления ${notificationId}`);
    if (targetUrl === '/notifications' || targetUrl === '#') {
        console.warn('Целевой URL не задан или некорректен, переход отменен');
        window.NotificationUtils.showAlert('danger', 'Целевая страница не указана');
        return;
    }

    fetch(`/notifications/mark_read/${notificationId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => {
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        return response.json();
    })
    .then(data => {
        if (data.status === 'success') {
            window.location.href = targetUrl;
        } else {
            window.NotificationUtils.showAlert('danger', data.message || 'Ошибка при обновлении уведомления');
        }
    })
    .catch(error => {
        console.error('Ошибка:', error);
        window.NotificationUtils.showAlert('danger', `Ошибка при переходе: ${error.message}`);
    });
}

/**
 * Очищает все уведомления.
 */
function clearAllNotifications() {
    const button = document.getElementById('clearNotificationsBtn');
    const originalText = button.innerHTML;

    if (!confirm('Вы уверены, что хотите удалить все уведомления?')) {
        return;
    }

    button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Обработка...';
    button.disabled = true;

    fetch('/notifications/clear', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => {
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        return response.json();
    })
    .then(data => {
        if (data.status === 'success') {
            const tableBody = document.getElementById('notifications-table-body');
            tableBody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">Нет уведомлений</td></tr>';
            const paginationContainer = document.querySelector('.pagination');
            if (paginationContainer) paginationContainer.innerHTML = '';
            window.NotificationUtils.showAlert('success', data.message);
            window.NotificationUtils.loadNotifications();
        } else {
            window.NotificationUtils.showAlert('danger', data.message || 'Ошибка при очистке уведомлений');
        }
    })
    .catch(error => {
        console.error('Ошибка:', error);
        window.NotificationUtils.showAlert('danger', `Ошибка при очистке уведомлений: ${error.message}`);
    })
    .finally(() => {
        button.innerHTML = originalText;
        button.disabled = false;
    });
}

/**
 * Динамически обновляет таблицу уведомлений.
 */
function updateNotificationsTable(notifications) {
    const tableBody = document.getElementById('notifications-table-body');
    tableBody.innerHTML = '';

    if (notifications.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">Нет уведомлений</td></tr>';
        return;
    }

    notifications.forEach(notification => {
        const row = document.createElement('tr');
        row.className = notification.is_read ? '' : 'table-info';
        row.dataset.notificationId = notification.id;
        row.dataset.targetUrl = notification.target_url;

        if (notification.target_url && notification.target_url !== '/notifications' && notification.target_url !== '#') {
            row.style.cursor = 'pointer';
            row.onclick = () => redirectToTarget(notification.id, notification.target_url);
        }

        const formattedMessage = formatNotificationMessage(
            window.NotificationUtils.escapeHtml(notification.message),
            notification.target_url
        );

        row.innerHTML = `
            <td>${notification.id}</td>
            <td class="notification-message">${formattedMessage}</td>
            <td>${notification.created_at}</td>
            <td>
                ${notification.is_read
                    ? '<span class="badge bg-success">Прочитано</span>'
                    : '<span class="badge bg-warning">Непрочитано</span>'}
            </td>
        `;
        tableBody.appendChild(row);
    });
}

document.addEventListener('DOMContentLoaded', function() {
    const clearNotificationsBtn = document.getElementById('clearNotificationsBtn');
    if (clearNotificationsBtn) {
        clearNotificationsBtn.addEventListener('click', clearAllNotifications);
    } else {
        console.error('Кнопка clearNotificationsBtn не найдена');
    }

    // Применяем форматирование сообщений к уже загруженным уведомлениям
    document.querySelectorAll('#notifications-table-body tr').forEach(row => {
        const messageCell = row.querySelector('.notification-message');
        const targetUrl = row.dataset.targetUrl || '';
        if (messageCell) {
            const originalMessage = messageCell.textContent;
            messageCell.textContent = formatNotificationMessage(originalMessage, targetUrl);
        }
    });

    // Периодическая проверка новых уведомлений
    if (window.NotificationUtils && window.NotificationUtils.loadNotifications) {
        window.NotificationUtils.loadNotifications();
        setInterval(() => {
            window.NotificationUtils.loadNotifications();
        }, 30000); // Проверка каждые 30 секунд
    } else {
        console.error('window.NotificationUtils.loadNotifications не определена');
    }

    // Обработчик кликов по пагинации
    document.querySelectorAll('.pagination .page-link').forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            const page = parseInt(this.getAttribute('onclick').match(/\d+/)[0]);
            if (!isNaN(page)) loadPage(page);
        });
    });
});
</script>
{% endblock %}