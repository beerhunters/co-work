{% extends "base.html" %}
{% block title %}Уведомления{% endblock %}
{% block content_title %}Уведомления{% endblock %}
{% block content %}
<style>
    .table-container {
        max-height: 600px;
        overflow-y: auto;
        margin-top: 1rem;
    }
</style>

<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h3 class="card-title mb-0">Список уведомлений</h3>
        <div class="card-tools">
            <button type="button" class="btn btn-sm btn-primary me-2" onclick="markAllNotificationsReadPage()">
                <i class="fas fa-check-double me-1"></i>Отметить все как прочитанные
            </button>
            <button type="button" class="btn btn-sm btn-danger" id="clearNotificationsBtn">
                <i class="fas fa-trash me-1"></i>Очистить список уведомлений
            </button>
        </div>
    </div>
    <div class="card-body">
        <div class="table-container">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>ID</th>
                            <th>Сообщение</th>
                            <th>Дата создания</th>
                            <th>Статус</th>
                            <th>Действия</th>
                        </tr>
                    </thead>
                    <tbody id="notifications-table-body">
                        {% for notification in recent_notifications %}
                        <tr class="{{ 'table-info' if not notification.is_read else '' }}"
                            data-notification-id="{{ notification.id }}"
                            onclick="redirectToTarget({{ notification.id }}, '{{ notification.target_url }}')"
                            style="cursor: {{ 'pointer' if notification.target_url != '/notifications' else 'default' }};">
                            <td>{{ notification.id }}</td>
                            <td>{{ notification.message }}</td>
                            <td>{{ notification.created_at }}</td>
                            <td>
                                {% if notification.is_read %}
                                    <span class="badge bg-success">Прочитано</span>
                                {% else %}
                                    <span class="badge bg-warning">Непрочитано</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if not notification.is_read %}
                                    <button type="button" class="btn btn-sm btn-outline-primary"
                                            onclick="markSingleNotificationRead({{ notification.id }}); event.stopPropagation();">
                                        <i class="fas fa-check"></i> Прочитать
                                    </button>
                                {% endif %}
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="5" class="text-center text-muted">Нет уведомлений</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
/**
 * Показывает уведомление Bootstrap.
 * @param {string} type - Тип уведомления ('success', 'danger').
 * @param {string} message - Сообщение для отображения.
 */
function showAlert(type, message) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.role = 'alert';
    alertDiv.innerHTML = `
        ${window.NotificationUtils.escapeHtml(message)}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    `;
    const main = document.querySelector('main');
    if (main) {
        main.prepend(alertDiv);
        setTimeout(() => {
            alertDiv.classList.remove('show');
            setTimeout(() => {
                if (alertDiv.parentNode) alertDiv.remove();
            }, 300);
        }, 5000);
    } else {
        console.error('Не найден элемент main для alert');
    }
}

/**
 * Помечает все уведомления как прочитанные на странице.
 */
function markAllNotificationsReadPage() {
    const button = event.target.closest('button');
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Обработка...';
    button.disabled = true;

    fetch('/notifications/mark_all_read', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => {
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        return response.json();
    })
    .then(data => {
        if (data.status === 'success') {
            const rows = document.querySelectorAll('#notifications-table-body tr[data-notification-id]');
            rows.forEach(row => {
                row.classList.remove('table-info');
                const statusCell = row.children[3];
                statusCell.innerHTML = '<span class="badge bg-success">Прочитано</span>';
                const actionCell = row.children[4];
                actionCell.innerHTML = '';
            });
            window.NotificationUtils.showAlert('success', data.message);
            window.NotificationUtils.loadNotifications();
        } else {
            window.NotificationUtils.showAlert('danger', data.message || 'Ошибка при обновлении уведомлений');
        }
    })
    .catch(error => {
        console.error('Ошибка:', error);
        window.NotificationUtils.showAlert('danger', `Ошибка при обновлении уведомлений: ${error.message}`);
    })
    .finally(() => {
        button.innerHTML = originalText;
        button.disabled = false;
    });
}

/**
 * Помечает одно уведомление как прочитанное.
 * @param {number} notificationId - ID уведомления.
 */
function markSingleNotificationRead(notificationId) {
    const button = event.target.closest('button');
    const row = button.closest('tr');
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    button.disabled = true;

    fetch(`/notifications/mark_read/${notificationId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => {
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        return response.json();
    })
    .then(data => {
        if (data.status === 'success') {
            row.classList.remove('table-info');
            const statusCell = row.children[3];
            statusCell.innerHTML = '<span class="badge bg-success">Прочитано</span>';
            button.remove();
            window.NotificationUtils.loadNotifications();
        } else {
            window.NotificationUtils.showAlert('danger', data.message || 'Ошибка при обновлении уведомления');
            button.innerHTML = originalText;
            button.disabled = false;
        }
    })
    .catch(error => {
        console.error('Ошибка:', error);
        window.NotificationUtils.showAlert('danger', `Ошибка при обновлении уведомления: ${error.message}`);
        button.innerHTML = originalText;
        button.disabled = false;
    });
}

/**
 * Переход на целевую страницу с пометкой уведомления как прочитанного.
 * @param {number} notificationId - ID уведомления.
 * @param {string} targetUrl - URL для перехода.
 */
function redirectToTarget(notificationId, targetUrl) {
    console.log(`Переход на ${targetUrl} для уведомления ${notificationId}`);
    if (targetUrl === '/notifications' || targetUrl === '#') {
        console.warn('Целевой URL не задан или некорректен, переход отменен');
        window.NotificationUtils.showAlert('danger', 'Целевая страница не указана');
        return;
    }

    fetch(`/notifications/mark_read/${notificationId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => {
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        return response.json();
    })
    .then(data => {
        if (data.status === 'success') {
            window.location.href = targetUrl;
        } else {
            window.NotificationUtils.showAlert('danger', data.message || 'Ошибка при обновлении уведомления');
        }
    })
    .catch(error => {
        console.error('Ошибка:', error);
        window.NotificationUtils.showAlert('danger', `Ошибка при переходе: ${error.message}`);
    });
}

/**
 * Очищает все уведомления.
 */
function clearAllNotifications() {
    const button = document.getElementById('clearNotificationsBtn');
    const originalText = button.innerHTML;

    if (!confirm('Вы уверены, что хотите удалить все уведомления?')) {
        return;
    }

    button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Обработка...';
    button.disabled = true;

    fetch('/notifications/clear', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => {
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        return response.json();
    })
    .then(data => {
        if (data.status === 'success') {
            const tableBody = document.getElementById('notifications-table-body');
            tableBody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">Нет уведомлений</td></tr>';
            window.NotificationUtils.showAlert('success', data.message);
            window.NotificationUtils.loadNotifications();
        } else {
            window.NotificationUtils.showAlert('danger', data.message || 'Ошибка при очистке уведомлений');
        }
    })
    .catch(error => {
        console.error('Ошибка:', error);
        window.NotificationUtils.showAlert('danger', `Ошибка при очистке уведомлений: ${error.message}`);
    })
    .finally(() => {
        button.innerHTML = originalText;
        button.disabled = false;
    });
}

/**
 * Динамически обновляет таблицу уведомлений.
 */
function updateNotificationsTable(notifications) {
    const tableBody = document.getElementById('notifications-table-body');
    tableBody.innerHTML = '';

    if (notifications.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">Нет уведомлений</td></tr>';
        return;
    }

    notifications.forEach(notification => {
        const row = document.createElement('tr');
        row.className = notification.is_read ? '' : 'table-info';
        row.dataset.notificationId = notification.id;

        if (notification.target_url && notification.target_url !== '/notifications' && notification.target_url !== '#') {
            row.style.cursor = 'pointer';
            row.onclick = () => redirectToTarget(notification.id, notification.target_url);
        }

        row.innerHTML = `
            <td>${notification.id}</td>
            <td>${window.NotificationUtils.escapeHtml(notification.message)}</td>
            <td>${notification.created_at}</td>
            <td>
                ${notification.is_read
                    ? '<span class="badge bg-success">Прочитано</span>'
                    : '<span class="badge bg-warning">Непрочитано</span>'}
            </td>
            <td>
                ${!notification.is_read
                    ? `<button type="button" class="btn btn-sm btn-outline-primary"
                               onclick="markSingleNotificationRead(${notification.id}); event.stopPropagation();">
                            <i class="fas fa-check"></i> Прочитать
                       </button>`
                    : ''}
            </td>
        `;
        tableBody.appendChild(row);
    });
}

document.addEventListener('DOMContentLoaded', function() {
    const clearNotificationsBtn = document.getElementById('clearNotificationsBtn');
    if (clearNotificationsBtn) {
        clearNotificationsBtn.addEventListener('click', clearAllNotifications);
    } else {
        console.error('Кнопка clearNotificationsBtn не найдена');
    }

    // Периодическая проверка новых уведомлений
    if (window.NotificationUtils && window.NotificationUtils.loadNotifications) {
        window.NotificationUtils.loadNotifications();
        setInterval(() => {
            window.NotificationUtils.loadNotifications();
        }, 30000); // Проверка каждые 30 секунд
    } else {
        console.error('window.NotificationUtils.loadNotifications не определена');
    }
});
</script>
{% endblock %}